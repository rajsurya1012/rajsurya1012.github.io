<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Vision based multi drone control | Raj Surya </title> <meta name="author" content="Raj Surya Rajendran Kathirvel"> <meta name="description" content="Trajectory following of multiple drones using RGB Camera"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/robot_icon.jpg?d3ea44ecfa0e63d993125af47d076bde"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://rajsurya1012.github.io/projects/2_project/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Raj Surya </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">Projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Vision based multi drone control</h1> <p class="post-description">Trajectory following of multiple drones using RGB Camera</p> </header> <article> <h3 id="secured-silver-medal-in-the-interiit-techmeet-110-aerial-robotics-competition">Secured silver medal in the InterIIT Techmeet 11.0 Aerial Robotics Competition</h3> <h3 id="team">Team</h3> <p>Raj Surya, Aman Singh</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/drone/drone_flying-480.webp 480w,/assets/drone/drone_flying-800.webp 800w,/assets/drone/drone_flying-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/drone/drone_flying.gif" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="head" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Drone in action. </div> <h3 id="task-1">Task 1</h3> <p>To fly the drone by sending MSP (Multiwii Serial Protocol) packets via Wifi communication. The flight controller board has an ESP 8266 wifi module, which allows communication between the drone and a PC. A TCP connection is established between the PC and the drone using python’s Socket library.</p> <h4 id="the-socket-library">The Socket Library</h4> <p>The socket library is a collection of low-level programming interfaces for creating network connections and exchanging data between systems over a network. It allows programmers to create and manage client-server applications that send and receive data through a network. The socket library provides a standard set of functions and protocols for communication, making it easier to develop applications that run on different operating systems and network configurations. Additionally, the socket library is widely used for various types of network applications, including web servers, instant messaging services, and file transfer protocols.</p> <h4 id="data-packects-for-communication">Data packects for communication</h4> <p>A set of data packets are predefined for the pluto drone that allows to send actuation commands and receive raw/processed sensor data. The packets are structured in Multiwii Serial Protocol (MSP) format. There are several packet types, out of which MSP_SET_RAW_RC and MSP_SET_COMMAND are the ’in’ packets, i.e. from computer to the drone. MSP_SET_RAW_RC is enough to fly the drone using an external controller, a human or a computer algorithm, as it allows to set the roll, pitch, yaw and throttle values to a desired point. Also various modes can be selected like altitude hold, auto pilot etc. MSP_SET_COMMAND allows to perform some inbuilt actions like takeoff, land and flips using the integrated inertial sensor. For the first task, a python wrapper is created which includes functions for arm, disarm, takeoff, land and setting the desired values for roll/pitch/yaw/throttle. Instead of separate functions for all, a single function call sends the desired values for all the actions. This allows the user to set simultaneous values (for example roll and pitch can occur together), which is helpful to apply automatic control for the drone further.</p> <h3 id="task-2---part-1">Task 2 - Part 1</h3> <p>To make the drone hover at a particular height using the position obtained using ArUco marker. In order to control the drone position, we need a feedback system that will tell its (atleast) current position with a good update rate. From the position data, velocity can be obtained by discrete differentiation. Update rate is important as the given system has low inertia, hence is very agile. Existing methods include GPS, laser based distance sensors, camera based pose estimation etc. Inertial systems are also used but have limited reliability because of the induced drift due to the integration involved. GPS cannot be used for indoor flights and has slow update rate. Light and sound based distance sensors are fast and can be used indoors, but are trickier to work with as the chance of false estimation due to moving objects or another interfering light/sound source can cause problems. Camera based pose estimation techniques also have certain pros and cons. They are more robust as the data under observation is comparatively much larger in size (image is a 2X2 matrix hence contain much larger information). However due to the large data size, data acquisition and processing takes more time and energy. Here we are going with camera based pose estimation with an external camera, i.e. camera is fixed outside the quadcopter. Also the data processing and control is done on an external PC and data sent via wireless communication using MSP packets as described in Task 1.</p> <p>#### Aruco Marker Now to locate the drone in the image coming from camera feed, ArUco tag are used. These markers uses black and white square blocks of specific sizes to encode certain information given by the user (ID). The number of square blocks also vary according to the size of information to be encoded. We have used a 4X4 ArUco tag for the detection purpose. Basically the detection of ArUco markers depend upon corner detection algorithms, as the marker has very high contrast (assuming the print quality is good enough). But to extract the relative position from the detected marker, the camera needs to be calibrated.</p> <p>#### Camera calibration and Pose estimation Camera calibration is the process of determining the intrinsic and extrinsic parameters of a camera. These parameters describe the camera’s internal characteristics, such as its focal length, and its position and orientation in the world. Intrinsic parameters describe the camera’s internal optical and mechanical characteristics and include the focal length, principal point, and radial distortion coefficients. These parameters affect the scale, aspect ratio, and radial distortion of the captured images. The camera lens creates image distortion. Extrinsic parameters describe the position and orientation of the camera in the world and include the rotation and translation vectors. These parameters are important for determining the position of objects in 3D space. After proper calibration, relative position can be obtained from the camera centered coordinate frame. In order to move from one position to the other, it is needed to first know the current position and the goal position relative to it. Then the drone can start moving towards the goal position until the relative distance (error) becomes zero. However if the world is ideal, the drone can start suddenly with a non zero velocity, travel with the same velocity and suddenly stop as soon as the goal is reached. But that means infinite acceleration at the starting and ending points, which is not possible in real world. Hence the actuation commands of the drone needs to be a function of the current error (between starting and ending points).</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/drone/camera_calib-480.webp 480w,/assets/drone/camera_calib-800.webp 800w,/assets/drone/camera_calib-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/drone/camera_calib.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="head" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Camera Calibration. </div> <p>#### Challenges Faced</p> <ul> <li>Pure translation along z-axis with respect to the camera frame results in slight change in the x,y coordinates as well due to the pin hole model of camera (expanding Field Of View (FOV)).</li> <li>Low resolution form the camera gave a good update rate (for the complete algorithm), but could not detect the markers robustly whereas high resolution detected better but made the update rate slower.</li> <li>The black ink (with which marker was printed) is pretty shiny and causes hindrance in detection.</li> <li>The focal length and field of view of the camera also posed challenges.</li> </ul> <h4 id="pid-control">PID Control</h4> <p>PID stands for Proportional Integral Derivative control. Here proportional control part simply scales the error, which is feeded to the actuator. But there is mostly some delay involved in reading the sensor data and producing the actuator commands, this is called phase delay. Due to it having only proportional control will cause oscillations, which may even grow over time and make the system unstable. Hence the system needs to have some damping to atleast contain the oscillation, which can later be fine tuned to achieve a good response. Generally systems have damping due friction and fluid drags, but the effect may vary. For example in our drone, lateral movement (roll, pitch) has very low drag when the drone is natural hovering position. Also there is a plenty of phase lag caused by marker detection and pose estimation part. Hence, a derivative term is needed in the controller design to create the necessary damping. This will also be used to track velocity while doing trajectory tracking. The integral term is used in removing steady state error caused due to deviation in estimation of parameters like mass, PWM input to thrust output mapping, inertia etc. However it is kept low as there is potential to induce oscillation. The integrator part also has saturation limits to keep the control outputs within limit. To put it together proportional term takes care of present, derivative term sets the future and integrator laments on the past mistakes!</p> <h4 id="discretization-and-filtering">Discretization and filtering</h4> <p>However to implement it in computer we need discretized model. There are several approximation methods for the approximations of the integral and derivative terms. Also pure differentiation is avoided to reduce the effect of noise. In our case we have pre-filtered the position data using a 5 point moving average filter. The reason for choosing FIR (Finite Impulse Response) filter over IIR (Infinite Impulse Response) filter is the amount of phase lag introduced by IIR filter. Since the system is pretty agile, it is very sensitive to any amount of phase lag. Lastly by fine tuning all the gains, hovering was achieved.</p> <h4 id="results">Results</h4> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/drone/hover-480.webp 480w,/assets/drone/hover-800.webp 800w,/assets/drone/hover-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/drone/hover.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="head" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Plot of drone hovering. </div> <h3 id="task-2---part-2">Task 2 - Part 2</h3> <p>To make drone traverse a rectangular path using ArUCo based pose detection. After having the PID control in place, it is possible to guide the drone by giving desired positions as a function of time. For a simple path like a straight line, just a single point as the desired point is sufficient. But the acceleration profile mostly looks like a straight line segment with negative slope, crossing zero at the mid-point.</p> <h4 id="quintic-polynomial-approximation-for-waypoints">Quintic polynomial approximation for waypoints</h4> <p>Here we can notice that there are jerks at the start and end points. But with the simple PID controller, we don’t have control over the acceleration, i.e. second order boundary conditions. Hence instead of giving the end point directly as the desired point, the path can be divided into fine steps, whose step size will be governed by a 5th order (quintic) polynomial. Since the polynomial is differentiable more than two times, it is possible to set a desired initial and final acceleration, which is mostly kept zero. This way jerk can be removed.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/drone/velocity-480.webp 480w,/assets/drone/velocity-800.webp 800w,/assets/drone/velocity-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/drone/velocity.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="bottleneck" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/drone/acceleration-480.webp 480w,/assets/drone/acceleration-800.webp 800w,/assets/drone/acceleration-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/drone/acceleration.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="bottleneck" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Left: Velocity profile. Right: Acceleration profile. </div> <p>Here we can observe the smooth trend in acceleration which removes jerk. However we did not adopt this approach in the final submission because of the limited update rate. The desired position values update at a certain rate, which needs to be perfectly captured by the controller to get an agile system. But due to the phase delays and other limitations it was forcing to reduce the overall travelling speed of the drone (i.e. the time for completing one straight line had to be kept long enough).</p> <p>Hence directly desired setpoints are given to the controller after specific intervals to complete the required rectangular trajectory.</p> <h4 id="results-1">Results</h4> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/drone/trajectory-480.webp 480w,/assets/drone/trajectory-800.webp 800w,/assets/drone/trajectory-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/drone/trajectory.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="head" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Trajectory followed by the drone. </div> <h4 id="task-3">Task 3</h4> <p>Program a follower drone that follows the master drone’s path.</p> <h4 id="approach">Approach</h4> <p>The pose of the first drone obtained using Aruco marker was fed as the target location for the second drone. The second drone was also controlled using a aruco marker. The main challenge was when one drone flies below another drone, then the pose of the drone flying under cannot be determined because it is not in sight and hence the control fails. This was the final task and was programmed during the contest on-spot, hence I don’t have any media related to it. The files were submitted on spot as well.</p> <h4 id="conclusion">Conclusion</h4> <p>The accuracy of resultant path mostly depends on the detection of ArUco marker and position estimation. Hence the type of camera and its specifications greatly affects the overall performance. Also lighting, marker quality (printing) and drones speed creates significant effect. The performance can be drastically improved by using a high speed camera with good Field of View.</p> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Raj Surya Rajendran Kathirvel. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>